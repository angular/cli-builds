"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable:no-global-tslint-disable no-any file-header
const core_1 = require("@angular-devkit/core");
const yargsParser = require("yargs-parser");
const command_1 = require("../models/command");
const project_1 = require("../utilities/project");
// Based off https://en.wikipedia.org/wiki/Levenshtein_distance
// No optimization, really.
function levenshtein(a, b) {
    /* base case: empty strings */
    if (a.length == 0) {
        return b.length;
    }
    if (b.length == 0) {
        return a.length;
    }
    // Test if last characters of the strings match.
    const cost = a[a.length - 1] == b[b.length - 1] ? 0 : 1;
    /* return minimum of delete char from s, delete char from t, and delete char from both */
    return Math.min(levenshtein(a.slice(0, -1), b) + 1, levenshtein(a, b.slice(0, -1)) + 1, levenshtein(a.slice(0, -1), b.slice(0, -1)) + cost);
}
/**
 * Run a command.
 * @param commandMap Map of available commands.
 * @param args Raw unparsed arguments.
 * @param logger The logger to use.
 * @param context Execution context.
 */
function runCommand(commandMap, args, logger, context) {
    return __awaiter(this, void 0, void 0, function* () {
        // if not args supplied, just run the help command.
        if (!args || args.length === 0) {
            args = ['help'];
        }
        const rawOptions = yargsParser(args, { alias: { help: ['h'] }, boolean: ['help'] });
        let commandName = rawOptions._[0];
        // remove the command name
        rawOptions._ = rawOptions._.slice(1);
        const executionScope = project_1.insideProject()
            ? command_1.CommandScope.inProject
            : command_1.CommandScope.outsideProject;
        let Cmd;
        Cmd = findCommand(commandMap, commandName);
        if (!Cmd && !commandName && (rawOptions.v || rawOptions.version)) {
            commandName = 'version';
            Cmd = findCommand(commandMap, commandName);
        }
        if (!Cmd && rawOptions.help) {
            commandName = 'help';
            Cmd = findCommand(commandMap, commandName);
        }
        if (!Cmd) {
            const commandsDistance = {};
            const allCommands = listAllCommandNames(commandMap).sort((a, b) => {
                if (!(a in commandsDistance)) {
                    commandsDistance[a] = levenshtein(a, commandName);
                }
                if (!(b in commandsDistance)) {
                    commandsDistance[b] = levenshtein(b, commandName);
                }
                return commandsDistance[a] - commandsDistance[b];
            });
            logger.error(core_1.tags.stripIndent `
        The specified command ("${commandName}") is invalid. For a list of available options,
        run "ng help".

        Did you mean "${allCommands[0]}"?
    `);
            return 1;
        }
        const command = new Cmd(context, logger);
        args = yield command.initializeRaw(args);
        let options = parseOptions(args, command.options, command.arguments, command.argStrategy);
        yield command.initialize(options);
        options = parseOptions(args, command.options, command.arguments, command.argStrategy);
        if (commandName === 'help') {
            options.commandMap = commandMap;
        }
        if (options.help) {
            command.printHelp(options);
            return;
        }
        else {
            if (command.scope !== undefined && command.scope !== command_1.CommandScope.everywhere) {
                if (command.scope !== executionScope) {
                    let errorMessage;
                    if (command.scope === command_1.CommandScope.inProject) {
                        errorMessage = `This command can only be run inside of a CLI project.`;
                    }
                    else {
                        errorMessage = `This command can not be run inside of a CLI project.`;
                    }
                    logger.fatal(errorMessage);
                    return 1;
                }
                if (command.scope === command_1.CommandScope.inProject) {
                    if (!context.project.configFile) {
                        logger.fatal('Invalid project: missing workspace file.');
                        return 1;
                    }
                    if (['.angular-cli.json', 'angular-cli.json'].includes(context.project.configFile)) {
                        // --------------------------------------------------------------------------------
                        // If changing this message, please update the same message in
                        // `packages/@angular/cli/bin/ng-update-message.js`
                        const message = core_1.tags.stripIndent `
            The Angular CLI configuration format has been changed, and your existing configuration
            can be updated automatically by running the following command:

              ng update @angular/cli
          `;
                        logger.warn(message);
                        return 1;
                    }
                }
            }
            delete options.h;
            delete options.help;
            const isValid = yield command.validate(options);
            if (!isValid) {
                logger.fatal(`Validation error. Invalid command`);
                return 1;
            }
            return yield command.run(options);
        }
    });
}
exports.runCommand = runCommand;
function parseOptions(args, cmdOpts, commandArguments, argStrategy) {
    const parser = yargsParser;
    const aliases = cmdOpts.concat()
        .filter(o => o.aliases && o.aliases.length > 0)
        .reduce((aliases, opt) => {
        aliases[opt.name] = (opt.aliases || [])
            .filter(a => a.length === 1);
        return aliases;
    }, {});
    const booleans = cmdOpts
        .filter(o => o.type && o.type === Boolean)
        .map(o => o.name);
    const defaults = cmdOpts
        .filter(o => o.default !== undefined || booleans.indexOf(o.name) !== -1)
        .reduce((defaults, opt) => {
        defaults[opt.name] = opt.default;
        return defaults;
    }, {});
    const strings = cmdOpts
        .filter(o => o.type === String)
        .map(o => o.name);
    const numbers = cmdOpts
        .filter(o => o.type === Number)
        .map(o => o.name);
    aliases.help = ['h'];
    booleans.push('help');
    const yargsOptions = {
        alias: aliases,
        boolean: booleans,
        default: defaults,
        string: strings,
        number: numbers,
    };
    const parsedOptions = parser(args, yargsOptions);
    // Remove aliases.
    cmdOpts
        .filter(o => o.aliases && o.aliases.length > 0)
        .map(o => o.aliases)
        .reduce((allAliases, aliases) => {
        return allAliases.concat([...aliases]);
    }, [])
        .forEach((alias) => {
        delete parsedOptions[alias];
    });
    // Remove undefined booleans
    booleans
        .filter(b => parsedOptions[b] === undefined)
        .map(b => core_1.strings.camelize(b))
        .forEach(b => delete parsedOptions[b]);
    // remove options with dashes.
    Object.keys(parsedOptions)
        .filter(key => key.indexOf('-') !== -1)
        .forEach(key => delete parsedOptions[key]);
    // remove the command name
    parsedOptions._ = parsedOptions._.slice(1);
    switch (argStrategy) {
        case command_1.ArgumentStrategy.MapToOptions:
            parsedOptions._.forEach((value, index) => {
                const arg = commandArguments[index];
                if (arg) {
                    parsedOptions[arg] = value;
                }
            });
            delete parsedOptions._;
            break;
    }
    return parsedOptions;
}
exports.parseOptions = parseOptions;
// Find a command.
function findCommand(map, name) {
    let Cmd = map[name];
    if (!Cmd) {
        // find command via aliases
        Cmd = Object.keys(map)
            .filter(key => {
            if (!map[key].aliases) {
                return false;
            }
            const foundAlias = map[key].aliases
                .filter((alias) => alias === name);
            return foundAlias.length > 0;
        })
            .map((key) => {
            return map[key];
        })[0];
    }
    if (!Cmd) {
        return null;
    }
    return Cmd;
}
function listAllCommandNames(map) {
    return Object.keys(map).concat(Object.keys(map)
        .reduce((acc, key) => {
        if (!map[key].aliases) {
            return acc;
        }
        return acc.concat(map[key].aliases);
    }, []));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC1ydW5uZXIuanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXIvY2xpL21vZGVscy9jb21tYW5kLXJ1bm5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkRBQTZEO0FBQzdELCtDQUE2RTtBQUM3RSw0Q0FBNEM7QUFDNUMsK0NBTTJCO0FBQzNCLGtEQUFxRDtBQU9yRCwrREFBK0Q7QUFDL0QsMkJBQTJCO0FBQzNCLHFCQUFxQixDQUFTLEVBQUUsQ0FBUztJQUN2Qyw4QkFBOEI7SUFDOUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVELGdEQUFnRDtJQUNoRCxNQUFNLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFeEQseUZBQXlGO0lBQ3pGLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUNiLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFDbEMsV0FBVyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUNsQyxXQUFXLENBQUMsQ0FBQyxDQUFD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QUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ1YsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNULE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFFRCw2QkFBNkIsR0FBZTtJQUMxQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQzVCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1NBQ2IsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQ25CLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNiLENBQUM7UUFFRCxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEMsQ0FBQyxFQUFFLEVBQWMsQ0FBQyxDQUNyQixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOm5vLWdsb2JhbC10c2xpbnQtZGlzYWJsZSBuby1hbnkgZmlsZS1oZWFkZXJcbmltcG9ydCB7IGxvZ2dpbmcsIHN0cmluZ3MgYXMgY29yZVN0cmluZ3MsIHRhZ3MgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgKiBhcyB5YXJnc1BhcnNlciBmcm9tICd5YXJncy1wYXJzZXInO1xuaW1wb3J0IHtcbiAgQXJndW1lbnRTdHJhdGVneSxcbiAgQ29tbWFuZENvbnN0cnVjdG9yLFxuICBDb21tYW5kQ29udGV4dCxcbiAgQ29tbWFuZFNjb3BlLFxuICBPcHRpb24sXG59IGZyb20gJy4uL21vZGVscy9jb21tYW5kJztcbmltcG9ydCB7IGluc2lkZVByb2plY3QgfSBmcm9tICcuLi91dGlsaXRpZXMvcHJvamVjdCc7XG5cblxuZXhwb3J0IGludGVyZmFjZSBDb21tYW5kTWFwIHtcbiAgW2tleTogc3RyaW5nXTogQ29tbWFuZENvbnN0cnVjdG9yO1xufVxuXG4vLyBCYXNlZCBvZmYgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTGV2ZW5zaHRlaW5fZGlzdGFuY2Vcbi8vIE5vIG9wdGltaXphdGlvbiwgcmVhbGx5LlxuZnVuY3Rpb24gbGV2ZW5zaHRlaW4oYTogc3RyaW5nLCBiOiBzdHJpbmcpOiBudW1iZXIge1xuICAvKiBiYXNlIGNhc2U6IGVtcHR5IHN0cmluZ3MgKi9cbiAgaWYgKGEubGVuZ3RoID09IDApIHtcbiAgICByZXR1cm4gYi5sZW5ndGg7XG4gIH1cbiAgaWYgKGIubGVuZ3RoID09IDApIHtcbiAgICByZXR1cm4gYS5sZW5ndGg7XG4gIH1cblxuICAvLyBUZXN0IGlmIGxhc3QgY2hhcmFjdGVycyBvZiB0aGUgc3RyaW5ncyBtYXRjaC5cbiAgY29uc3QgY29zdCA9IGFbYS5sZW5ndGggLSAxXSA9PSBiW2IubGVuZ3RoIC0gMV0gPyAwIDogMTtcblxuICAvKiByZXR1cm4gbWluaW11bSBvZiBkZWxldGUgY2hhciBmcm9tIHMsIGRlbGV0ZSBjaGFyIGZyb20gdCwgYW5kIGRlbGV0ZSBjaGFyIGZyb20gYm90aCAqL1xuICByZXR1cm4gTWF0aC5taW4oXG4gICAgbGV2ZW5zaHRlaW4oYS5zbGljZSgwLCAtMSksIGIpICsgMSxcbiAgICBsZXZlbnNodGVpbihhLCBiLnNsaWNlKDAsIC0xKSkgKyAxLFxuICAgIGxldmVuc2h0ZWluKGEuc2xpY2UoMCwgLTEpLCBiLnNsaWNlKDAsIC0xKSkgKyBjb3N0LFxuICApO1xufVxuXG4vKipcbiAqIFJ1biBhIGNvbW1hbmQuXG4gKiBAcGFyYW0gY29tbWFuZE1hcCBNYXAgb2YgYXZhaWxhYmxlIGNvbW1hbmRzLlxuICogQHBhcmFtIGFyZ3MgUmF3IHVucGFyc2VkIGFyZ3VtZW50cy5cbiAqIEBwYXJhbSBsb2dnZXIgVGhlIGxvZ2dlciB0byB1c2UuXG4gKiBAcGFyYW0gY29udGV4dCBFeGVjdXRpb24gY29udGV4dC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJ1bkNvbW1hbmQoY29tbWFuZE1hcDogQ29tbWFuZE1hcCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyOiBsb2dnaW5nLkxvZ2dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KTogUHJvbWlzZTxudW1iZXIgfCB2b2lkPiB7XG5cbiAgLy8gaWYgbm90IGFyZ3Mgc3VwcGxpZWQsIGp1c3QgcnVuIHRoZSBoZWxwIGNvbW1hbmQuXG4gIGlmICghYXJncyB8fCBhcmdzLmxlbmd0aCA9PT0gMCkge1xuICAgIGFyZ3MgPSBbJ2hlbHAnXTtcbiAgfVxuICBjb25zdCByYXdPcHRpb25zID0geWFyZ3NQYXJzZXIoYXJncywgeyBhbGlhczogeyBoZWxwOiBbJ2gnXSB9LCBib29sZWFuOiBbICdoZWxwJyBdIH0pO1xuICBsZXQgY29tbWFuZE5hbWUgPSByYXdPcHRpb25zLl9bMF07XG5cbiAgLy8gcmVtb3ZlIHRoZSBjb21tYW5kIG5hbWVcbiAgcmF3T3B0aW9ucy5fID0gcmF3T3B0aW9ucy5fLnNsaWNlKDEpO1xuICBjb25zdCBleGVjdXRpb25TY29wZSA9IGluc2lkZVByb2plY3QoKVxuICAgID8gQ29tbWFuZFNjb3BlLmluUHJvamVjdFxuICAgIDogQ29tbWFuZFNjb3BlLm91dHNpZGVQcm9qZWN0O1xuXG4gIGxldCBDbWQ6IENvbW1hbmRDb25zdHJ1Y3RvciB8IG51bGw7XG4gIENtZCA9IGZpbmRDb21tYW5kKGNvbW1hbmRNYXAsIGNvbW1hbmROYW1lKTtcblxuICBpZiAoIUNtZCAmJiAhY29tbWFuZE5hbWUgJiYgKHJhd09wdGlvbnMudiB8fCByYXdPcHRpb25zLnZlcnNpb24pKSB7XG4gICAgY29tbWFuZE5hbWUgPSAndmVyc2lvbic7XG4gICAgQ21kID0gZmluZENvbW1hbmQoY29tbWFuZE1hcCwgY29tbWFuZE5hbWUpO1xuICB9XG5cbiAgaWYgKCFDbWQgJiYgcmF3T3B0aW9ucy5oZWxwKSB7XG4gICAgY29tbWFuZE5hbWUgPSAnaGVscCc7XG4gICAgQ21kID0gZmluZENvbW1hbmQoY29tbWFuZE1hcCwgY29tbWFuZE5hbWUpO1xuICB9XG5cbiAgaWYgKCFDbWQpIHtcbiAgICBjb25zdCBjb21tYW5kc0Rpc3RhbmNlID0ge30gYXMgeyBbbmFtZTogc3RyaW5nXTogbnVtYmVyIH07XG4gICAgY29uc3QgYWxsQ29tbWFuZHMgPSBsaXN0QWxsQ29tbWFuZE5hbWVzKGNvbW1hbmRNYXApLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmICghKGEgaW4gY29tbWFuZHNEaXN0YW5jZSkpIHtcbiAgICAgICAgY29tbWFuZHNEaXN0YW5jZVthXSA9IGxldmVuc2h0ZWluKGEsIGNvbW1hbmROYW1lKTtcbiAgICAgIH1cbiAgICAgIGlmICghKGIgaW4gY29tbWFuZHNEaXN0YW5jZSkpIHtcbiAgICAgICAgY29tbWFuZHNEaXN0YW5jZVtiXSA9IGxldmVuc2h0ZWluKGIsIGNvbW1hbmROYW1lKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNvbW1hbmRzRGlzdGFuY2VbYV0gLSBjb21tYW5kc0Rpc3RhbmNlW2JdO1xuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmVycm9yKHRhZ3Muc3RyaXBJbmRlbnRgXG4gICAgICAgIFRoZSBzcGVjaWZpZWQgY29tbWFuZCAoXCIke2NvbW1hbmROYW1lfVwiKSBpcyBpbnZhbGlkLiBGb3IgYSBsaXN0IG9mIGF2YWlsYWJsZSBvcHRpb25zLFxuICAgICAgICBydW4gXCJuZyBoZWxwXCIuXG5cbiAgICAgICAgRGlkIHlvdSBtZWFuIFwiJHthbGxDb21tYW5kc1swXX1cIj9cbiAgICBgKTtcblxuICAgIHJldHVybiAxO1xuICB9XG5cbiAgY29uc3QgY29tbWFuZCA9IG5ldyBDbWQoY29udGV4dCwgbG9nZ2VyKTtcblxuICBhcmdzID0gYXdhaXQgY29tbWFuZC5pbml0aWFsaXplUmF3KGFyZ3MpO1xuICBsZXQgb3B0aW9ucyA9IHBhcnNlT3B0aW9ucyhhcmdzLCBjb21tYW5kLm9wdGlvbnMsIGNvbW1hbmQuYXJndW1lbnRzLCBjb21tYW5kLmFyZ1N0cmF0ZWd5KTtcbiAgYXdhaXQgY29tbWFuZC5pbml0aWFsaXplKG9wdGlvbnMpO1xuICBvcHRpb25zID0gcGFyc2VPcHRpb25zKGFyZ3MsIGNvbW1hbmQub3B0aW9ucywgY29tbWFuZC5hcmd1bWVudHMsIGNvbW1hbmQuYXJnU3RyYXRlZ3kpO1xuICBpZiAoY29tbWFuZE5hbWUgPT09ICdoZWxwJykge1xuICAgIG9wdGlvbnMuY29tbWFuZE1hcCA9IGNvbW1hbmRNYXA7XG4gIH1cblxuICBpZiAob3B0aW9ucy5oZWxwKSB7XG4gICAgY29tbWFuZC5wcmludEhlbHAob3B0aW9ucyk7XG5cbiAgICByZXR1cm47XG4gIH0gZWxzZSB7XG4gICAgaWYgKGNvbW1hbmQuc2NvcGUgIT09IHVuZGVmaW5lZCAmJiBjb21tYW5kLnNjb3BlICE9PSBDb21tYW5kU2NvcGUuZXZlcnl3aGVyZSkge1xuICAgICAgaWYgKGNvbW1hbmQuc2NvcGUgIT09IGV4ZWN1dGlvblNjb3BlKSB7XG4gICAgICAgIGxldCBlcnJvck1lc3NhZ2U7XG4gICAgICAgIGlmIChjb21tYW5kLnNjb3BlID09PSBDb21tYW5kU2NvcGUuaW5Qcm9qZWN0KSB7XG4gICAgICAgICAgZXJyb3JNZXNzYWdlID0gYFRoaXMgY29tbWFuZCBjYW4gb25seSBiZSBydW4gaW5zaWRlIG9mIGEgQ0xJIHByb2plY3QuYDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBlcnJvck1lc3NhZ2UgPSBgVGhpcyBjb21tYW5kIGNhbiBub3QgYmUgcnVuIGluc2lkZSBvZiBhIENMSSBwcm9qZWN0LmA7XG4gICAgICAgIH1cbiAgICAgICAgbG9nZ2VyLmZhdGFsKGVycm9yTWVzc2FnZSk7XG5cbiAgICAgICAgcmV0dXJuIDE7XG4gICAgICB9XG5cbiAgICAgIGlmIChjb21tYW5kLnNjb3BlID09PSBDb21tYW5kU2NvcGUuaW5Qcm9qZWN0KSB7XG4gICAgICAgIGlmICghY29udGV4dC5wcm9qZWN0LmNvbmZpZ0ZpbGUpIHtcbiAgICAgICAgICBsb2dnZXIuZmF0YWwoJ0ludmFsaWQgcHJvamVjdDogbWlzc2luZyB3b3Jrc3BhY2UgZmlsZS4nKTtcblxuICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFsnLmFuZ3VsYXItY2xpLmpzb24nLCAnYW5ndWxhci1jbGkuanNvbiddLmluY2x1ZGVzKGNvbnRleHQucHJvamVjdC5jb25maWdGaWxlKSkge1xuICAgICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgLy8gSWYgY2hhbmdpbmcgdGhpcyBtZXNzYWdlLCBwbGVhc2UgdXBkYXRlIHRoZSBzYW1lIG1lc3NhZ2UgaW5cbiAgICAgICAgICAvLyBgcGFja2FnZXMvQGFuZ3VsYXIvY2xpL2Jpbi9uZy11cGRhdGUtbWVzc2FnZS5qc2BcbiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gdGFncy5zdHJpcEluZGVudGBcbiAgICAgICAgICAgIFRoZSBBbmd1bGFyIENMSSBjb25maWd1cmF0aW9uIGZvcm1hdCBoYXMgYmVlbiBjaGFuZ2VkLCBhbmQgeW91ciBleGlzdGluZyBjb25maWd1cmF0aW9uXG4gICAgICAgICAgICBjYW4gYmUgdXBkYXRlZCBhdXRvbWF0aWNhbGx5IGJ5IHJ1bm5pbmcgdGhlIGZvbGxvd2luZyBjb21tYW5kOlxuXG4gICAgICAgICAgICAgIG5nIHVwZGF0ZSBAYW5ndWxhci9jbGlcbiAgICAgICAgICBgO1xuXG4gICAgICAgICAgbG9nZ2VyLndhcm4obWVzc2FnZSk7XG5cbiAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGRlbGV0ZSBvcHRpb25zLmg7XG4gICAgZGVsZXRlIG9wdGlvbnMuaGVscDtcblxuICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCBjb21tYW5kLnZhbGlkYXRlKG9wdGlvbnMpO1xuICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgbG9nZ2VyLmZhdGFsKGBWYWxpZGF0aW9uIGVycm9yLiBJbnZhbGlkIGNvbW1hbmRgKTtcblxuICAgICAgcmV0dXJuIDE7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IGNvbW1hbmQucnVuKG9wdGlvbnMpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZU9wdGlvbnM8VCA9IGFueT4oXG4gIGFyZ3M6IHN0cmluZ1tdLFxuICBjbWRPcHRzOiBPcHRpb25bXSxcbiAgY29tbWFuZEFyZ3VtZW50czogc3RyaW5nW10sXG4gIGFyZ1N0cmF0ZWd5OiBBcmd1bWVudFN0cmF0ZWd5LFxuKTogVCB7XG4gIGNvbnN0IHBhcnNlciA9IHlhcmdzUGFyc2VyO1xuXG4gIGNvbnN0IGFsaWFzZXMgPSBjbWRPcHRzLmNvbmNhdCgpXG4gICAgLmZpbHRlcihvID0+IG8uYWxpYXNlcyAmJiBvLmFsaWFzZXMubGVuZ3RoID4gMClcbiAgICAucmVkdWNlKChhbGlhc2VzOiBhbnksIG9wdDogT3B0aW9uKSA9PiB7XG4gICAgICBhbGlhc2VzW29wdC5uYW1lXSA9IChvcHQuYWxpYXNlcyB8fCBbXSlcbiAgICAgICAgLmZpbHRlcihhID0+IGEubGVuZ3RoID09PSAxKTtcblxuICAgICAgcmV0dXJuIGFsaWFzZXM7XG4gICAgfSwge30pO1xuXG4gIGNvbnN0IGJvb2xlYW5zID0gY21kT3B0c1xuICAgIC5maWx0ZXIobyA9PiBvLnR5cGUgJiYgby50eXBlID09PSBCb29sZWFuKVxuICAgIC5tYXAobyA9PiBvLm5hbWUpO1xuXG4gIGNvbnN0IGRlZmF1bHRzID0gY21kT3B0c1xuICAgIC5maWx0ZXIobyA9PiBvLmRlZmF1bHQgIT09IHVuZGVmaW5lZCB8fCBib29sZWFucy5pbmRleE9mKG8ubmFtZSkgIT09IC0xKVxuICAgIC5yZWR1Y2UoKGRlZmF1bHRzOiBhbnksIG9wdDogT3B0aW9uKSA9PiB7XG4gICAgICBkZWZhdWx0c1tvcHQubmFtZV0gPSBvcHQuZGVmYXVsdDtcblxuICAgICAgcmV0dXJuIGRlZmF1bHRzO1xuICAgIH0sIHt9KTtcblxuICBjb25zdCBzdHJpbmdzID0gY21kT3B0c1xuICAgIC5maWx0ZXIobyA9PiBvLnR5cGUgPT09IFN0cmluZylcbiAgICAubWFwKG8gPT4gby5uYW1lKTtcblxuICBjb25zdCBudW1iZXJzID0gY21kT3B0c1xuICAgIC5maWx0ZXIobyA9PiBvLnR5cGUgPT09IE51bWJlcilcbiAgICAubWFwKG8gPT4gby5uYW1lKTtcblxuXG4gIGFsaWFzZXMuaGVscCA9IFsnaCddO1xuICBib29sZWFucy5wdXNoKCdoZWxwJyk7XG5cbiAgY29uc3QgeWFyZ3NPcHRpb25zID0ge1xuICAgIGFsaWFzOiBhbGlhc2VzLFxuICAgIGJvb2xlYW46IGJvb2xlYW5zLFxuICAgIGRlZmF1bHQ6IGRlZmF1bHRzLFxuICAgIHN0cmluZzogc3RyaW5ncyxcbiAgICBudW1iZXI6IG51bWJlcnMsXG4gIH07XG5cbiAgY29uc3QgcGFyc2VkT3B0aW9ucyA9IHBhcnNlcihhcmdzLCB5YXJnc09wdGlvbnMpO1xuXG4gIC8vIFJlbW92ZSBhbGlhc2VzLlxuICBjbWRPcHRzXG4gICAgLmZpbHRlcihvID0+IG8uYWxpYXNlcyAmJiBvLmFsaWFzZXMubGVuZ3RoID4gMClcbiAgICAubWFwKG8gPT4gby5hbGlhc2VzKVxuICAgIC5yZWR1Y2UoKGFsbEFsaWFzZXM6IGFueSwgYWxpYXNlczogc3RyaW5nW10pID0+IHtcbiAgICAgIHJldHVybiBhbGxBbGlhc2VzLmNvbmNhdChbLi4uYWxpYXNlc10pO1xuICAgIH0sIFtdKVxuICAgIC5mb3JFYWNoKChhbGlhczogc3RyaW5nKSA9PiB7XG4gICAgICBkZWxldGUgcGFyc2VkT3B0aW9uc1thbGlhc107XG4gICAgfSk7XG5cbiAgLy8gUmVtb3ZlIHVuZGVmaW5lZCBib29sZWFuc1xuICBib29sZWFuc1xuICAgIC5maWx0ZXIoYiA9PiBwYXJzZWRPcHRpb25zW2JdID09PSB1bmRlZmluZWQpXG4gICAgLm1hcChiID0+IGNvcmVTdHJpbmdzLmNhbWVsaXplKGIpKVxuICAgIC5mb3JFYWNoKGIgPT4gZGVsZXRlIHBhcnNlZE9wdGlvbnNbYl0pO1xuXG4gIC8vIHJlbW92ZSBvcHRpb25zIHdpdGggZGFzaGVzLlxuICBPYmplY3Qua2V5cyhwYXJzZWRPcHRpb25zKVxuICAgIC5maWx0ZXIoa2V5ID0+IGtleS5pbmRleE9mKCctJykgIT09IC0xKVxuICAgIC5mb3JFYWNoKGtleSA9PiBkZWxldGUgcGFyc2VkT3B0aW9uc1trZXldKTtcblxuICAvLyByZW1vdmUgdGhlIGNvbW1hbmQgbmFtZVxuICBwYXJzZWRPcHRpb25zLl8gPSBwYXJzZWRPcHRpb25zLl8uc2xpY2UoMSk7XG5cbiAgc3dpdGNoIChhcmdTdHJhdGVneSkge1xuICAgIGNhc2UgQXJndW1lbnRTdHJhdGVneS5NYXBUb09wdGlvbnM6XG4gICAgICBwYXJzZWRPcHRpb25zLl8uZm9yRWFjaCgodmFsdWU6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCBhcmcgPSBjb21tYW5kQXJndW1lbnRzW2luZGV4XTtcbiAgICAgICAgaWYgKGFyZykge1xuICAgICAgICAgIHBhcnNlZE9wdGlvbnNbYXJnXSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgZGVsZXRlIHBhcnNlZE9wdGlvbnMuXztcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgcmV0dXJuIHBhcnNlZE9wdGlvbnM7XG59XG5cbi8vIEZpbmQgYSBjb21tYW5kLlxuZnVuY3Rpb24gZmluZENvbW1hbmQobWFwOiBDb21tYW5kTWFwLCBuYW1lOiBzdHJpbmcpOiBDb21tYW5kQ29uc3RydWN0b3IgfCBudWxsIHtcbiAgbGV0IENtZDogQ29tbWFuZENvbnN0cnVjdG9yID0gbWFwW25hbWVdO1xuXG4gIGlmICghQ21kKSB7XG4gICAgLy8gZmluZCBjb21tYW5kIHZpYSBhbGlhc2VzXG4gICAgQ21kID0gT2JqZWN0LmtleXMobWFwKVxuICAgICAgLmZpbHRlcihrZXkgPT4ge1xuICAgICAgICBpZiAoIW1hcFtrZXldLmFsaWFzZXMpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZm91bmRBbGlhcyA9IG1hcFtrZXldLmFsaWFzZXNcbiAgICAgICAgICAuZmlsdGVyKChhbGlhczogc3RyaW5nKSA9PiBhbGlhcyA9PT0gbmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIGZvdW5kQWxpYXMubGVuZ3RoID4gMDtcbiAgICAgIH0pXG4gICAgICAubWFwKChrZXkpID0+IHtcbiAgICAgICAgcmV0dXJuIG1hcFtrZXldO1xuICAgICAgfSlbMF07XG4gIH1cblxuICBpZiAoIUNtZCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcmV0dXJuIENtZDtcbn1cblxuZnVuY3Rpb24gbGlzdEFsbENvbW1hbmROYW1lcyhtYXA6IENvbW1hbmRNYXApOiBzdHJpbmdbXSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhtYXApLmNvbmNhdChcbiAgICBPYmplY3Qua2V5cyhtYXApXG4gICAgICAucmVkdWNlKChhY2MsIGtleSkgPT4ge1xuICAgICAgICBpZiAoIW1hcFtrZXldLmFsaWFzZXMpIHtcbiAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFjYy5jb25jYXQobWFwW2tleV0uYWxpYXNlcyk7XG4gICAgICB9LCBbXSBhcyBzdHJpbmdbXSksXG4gICk7XG59XG4iXX0=